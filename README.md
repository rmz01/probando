# ðŸ›°ï¸ TEIDESAT OPERATIVE SYSTEM FREERTOS - ESP32 

## ðŸŽ¯ Requirements

### Hardware
- ESP32 development board (ESP32-DOIT-DEVKIT-V1 recommended)
- USB cable (data capable)
- Computer with Linux (Gentoo tested)

### Software
- Visual Studio Code
- PlatformIO IDE extension
- Git

## ðŸ”§ ESP32 Setup

### 1. Install PlatformIO in VS Code
1. Open VS Code
2. Go to Extensions
3. Search for "PlatformIO IDE"
4. Install the extension

### 2. Configure USB Permissions (Linux/Gentoo)

#### Add user to required groups:
```bash
sudo usermod -a -G dialout,uucp,tty,plugdev $USER
```

#### Create udev rules for ESP32:
```bash
sudo nano /etc/udev/rules.d/49-esp32.rules
```

#### Add the following content:
https://raw.githubusercontent.com/platformio/platformio-core/develop/platformio/assets/system/99-platformio-udev.rules

#### Reload udev rules:
```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
```

#### Verify Setup
```bash
# Connect ESP32 and check device permissions
ls -la /dev/ttyUSB0
# Expected example: crw-rw-rw- 1 root dialout
```

## ðŸ“ Telemetry Architecture

The telemetry system is divided into modules with clear responsibilities to facilitate unit testing, maintenance, and extensibility:

| Module       | File (include/src)                       | Primary Responsibility                                                                 |
|--------------|-------------------------------------------|----------------------------------------------------------------------------------------|
| Acquisition  | `telemetry_acquisition.h/.cpp`            | Orchestrate packet generation from generators and store them in the buffer.          |
| Processing   | `telemetry_processing.h/.cpp`             | Retrieve packets and format them for logging/analytics.                              |
| Transmission | `telemetry_transmission.h/.cpp`           | Manage contact windows and (simulated) transmit all available packets.               |
| Logging      | `telemetry_logger.h/.cpp`                 | Persist data to LittleFS and output via Serial.                                      |
| Diagnostics  | `telemetry_diagnostics.h/.cpp`            | System health: periodic dumps, statistics, and status.                               |
| Storage      | `telemetry_storage.h/.cpp`                | Thread-safe circular buffer with mutexes and usage metrics.                          |
| Types        | `telemetry_types.h`                       | Definitions of structures and packet unions.                                         |

### Data Flow (Pipeline)
1. `telemetry_acquisition_cycle()` generates all types and stores them.
2. `telemetry_processing_handle_one()` consumes and formats packets for inspection.
3. `telemetry_transmission_cycle()` opens contact windows and transmits (simulated) remaining packets.
4. `telemetry_diagnostics_tick()` provides visibility (dump logs + buffer metrics + heap).

## ðŸŒ‰ Integration with Fomalhaut Ground Station

The telemetry logs generated by the ESP32 can be transmitted to the [Fomalhaut](https://github.com/Teidesat/Fomalhaut) ground station software via a Python bridge.

### Bridge Overview

```
ESP32 --[Serial]--> Python Bridge --[HTTP REST]--> Java-Spring Backend --> React Frontend
```

The bridge reads telemetry logs from the ESP32's serial port, parses them into structured JSON, and sends them to the Fomalhaut backend via HTTP POST requests.

### Quick Start

1. **Navigate to the bridge directory:**
   ```bash
   cd bridge
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Configure the bridge:**
   Edit `config.json` to set your serial port and backend URL:
   ```json
   {
     "serial": {
       "port": "/dev/ttyUSB0",
       "baudrate": 115200
     },
     "server": {
       "base_url": "http://localhost:8080"
     }
   }
   ```

4. **Run the bridge:**
   ```bash
   python3 esp32_to_fomalhaut_bridge.py
   ```

### Documentation

- **[Bridge README](bridge/README.md)** - Complete setup and usage guide
- **[Architecture](bridge/ARCHITECTURE.md)** - System architecture and data flow diagrams
- **[Backend Specification](bridge/BACKEND_SPEC.md)** - API endpoints for backend developers

### Supported Telemetry Types

The bridge automatically parses and forwards:
- **System:** CPU usage, RAM, stack info
- **Power:** Voltage, current, battery status
- **Temperature:** Sensor readings
- **Communications:** RSSI, SNR, packet statistics